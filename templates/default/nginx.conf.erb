user <%= node['nginx']['user'] %><% if node['nginx']['user'] != node['nginx']['group'] %> <%= node['nginx']['group'] %><% end %>;
worker_processes  <%= node['nginx']['worker_processes'] %>; ## = CPU qty

error_log   /var/log/nginx/error.log;
pid         /var/run/nginx.pid;

events {
    worker_connections  <%= node['nginx']['worker_connections'] %>;
    multi_accept        <%= node['nginx']['multi_accept'] %>;
    use                 epoll;
}

http {
    index         index.html index.php; ## Allow a static html file to be shown first
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    #log_format error403  '$remote_addr - "$http_x_forwarded_for" [$geoip_country_name] - [$time_local] '
    #                     ' "$request"';

    server_tokens  <%= node['nginx']['server_tokens'] %>;
    sendfile       <%= node['nginx']['multi_accept'] %>;
    tcp_nopush     <%= node['nginx']['tcp_nopush'] %>;
    tcp_nodelay    <%= node['nginx']['tcp_nodelay'] %>;


    ## Gzipping is an easy way to reduce page weight
    gzip             <%= node['nginx']['gzip'] %>;
    gzip_disable     "MSIE [1-6]\.";
    gzip_vary        <%= node['nginx']['gzip_vary'] %>;
    gzip_proxied     <%= node['nginx']['gzip_proxied'] %>;
    gzip_types       <%= node['nginx']['gzip_types'].join(' ') %>;
    gzip_buffers     <%= node['nginx']['gzip_buffers'] %>;
    gzip_comp_level  <%= node['nginx']['gzip_comp_level'] %>;
    gzip_min_length  <%= node['nginx']['gzip_min_length'] %>;

    <% if node['ssl'] %>
        ##  SSL global settings
        ssl_session_cache          shared:SSL:15m;
        ssl_session_timeout        15m;
        ssl_protocols              SSLv3 TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers                AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:RC4:HIGH:!MD5:!aNULL:!EDH;
        ssl_prefer_server_ciphers  on;
    <% end %>

    keepalive_timeout   <%= node['nginx']['keepalive_timeout'] %>;

	## Use when Varnish in front
	set_real_ip_from 127.0.0.1;
	real_ip_header X-Forwarded-For;

	## Nginx will not add the port in the url when the request is redirected.
        #port_in_redirect off;

	## Multi domain configuration
	   #values e.g.:
       #www.domain1.com default; ## default
	   #www.domain2.net 2store_code; ## EU store
	   #www.domain3.de 3store_code; ## German store
	   #www.domain4.com 4store_code; ## different products
	map $http_host $storecode {
    <% node[:magento]['nginx']['storecode_mapping'].each do |mapping| %>
      <%= mapping %>;
    <% end %>
	}

    include <%= node['nginx']['dir'] %>/conf.d/*.conf;
    include <%= node['nginx']['dir'] %>/sites-enabled/*;
}
